# AMAZON-sales-analysis-using-SQL
Image
### SQL Query 
## Business ProbLems 
## 1. Top Selling Products 
- Query the top 10 products by total sales value.
- Challenge: Include product name, total quantity sold, and total sales value.
```SQL
-- Create a new column 
ALTER TABLE dbo.[order_items]
ADD [total_sale] FLOAT;

-- Update the column with total sales value
UPDATE dbo.[order_items]
SET [total_sale] = [quantity] * [price_per_unit];

-- Retrieve the top 10 products by total sales value
SELECT TOP 10 
    oi.[product_id], 
    p.[product_name],
    SUM(oi.[quantity]) AS [total_quantity_sold],
    SUM(oi.[total_sale]) AS [total_sales_value]
FROM dbo.[orders] AS o
JOIN dbo.[order_items] AS oi
    ON o.[order_id] = oi.[order_id]
JOIN dbo.[products] AS p
    ON oi.[product_id] = p.[product_id]
GROUP BY oi.[product_id], p.[product_name]
ORDER BY SUM(oi.[total_sale]) DESC;
```
## 2. Revenue by Category
- Calculate total revenue generated by each product category.
- Challenge: Include the percentage contribution of each category to total revenue.
```sql
SELECT 
    p.[category_id],
    c.[category_name],
    SUM(oi.[total_sale]) AS [total_sale],
    SUM(oi.[total_sale]) / 
    (SELECT SUM([total_sale]) FROM dbo.[order_items]) * 100 AS [contribution_percentage]
FROM dbo.[order_items] AS oi
JOIN dbo.[products] AS p
    ON p.[product_id] = oi.[product_id]
LEFT JOIN dbo.[category] AS c
    ON c.[category_id] = p.[category_id]
GROUP BY 
    p.[category_id],
    c.[category_name]
ORDER BY SUM(oi.[total_sale]) DESC;
```
## 3. Average Order Value (AOV)
- Compute the average order value for each customer.
- Challenge: Include only customers with more than 5 orders
```sql
SELECT 
    c.[customer_id],
    CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
    SUM(oi.[total_sale]) / COUNT(o.[order_id]) AS [AOV],
    COUNT(o.[order_id]) AS [total_orders]
FROM dbo.[orders] AS o
JOIN dbo.[customers] AS c
    ON c.[customer_id] = o.[customer_id]
JOIN dbo.[order_items] AS oi
    ON oi.[order_id] = o.[order_id]
GROUP BY 
    c.[customer_id], 
    c.[first_name], 
    c.[last_name]
HAVING COUNT(o.[order_id]) > 5;
```
## 4. Monthly Sales Trend
- Query monthy total sales over the past year. 
- Challenge: Display the sales trend, grouping by month, return current_month sale, last month sale
```sql
-- Monthly Sales Trend: Current month sale and last month sale
WITH MonthlySales AS (
    SELECT 
        YEAR(o.[order_date]) AS [year],
        MONTH(o.[order_date]) AS [month],
        ROUND(SUM(oi.[total_sale]), 2) AS [total_sale]
    FROM dbo.[orders] AS o
    JOIN dbo.[order_items] AS oi
        ON o.[order_id] = oi.[order_id]
    WHERE o.[order_date] >= DATEADD(YEAR, -1, GETDATE()) -- Past one year
    GROUP BY 
        YEAR(o.[order_date]),
        MONTH(o.[order_date])
)
SELECT 
    [year],
    [month],
    [total_sale] AS [current_month_sale],
    LAG([total_sale], 1) OVER (ORDER BY [year], [month]) AS [last_month_sale]
FROM MonthlySales
ORDER BY [year], [month];
```
# 5. Customers with No Purchases 
- Find customers who have never placed an order.
```sql
SELECT 
    c.[customer_id],
    CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
    c.[email]
FROM dbo.[customers] AS c
LEFT JOIN dbo.[orders] AS o
    ON c.[customer_id] = o.[customer_id]
WHERE o.[customer_id] IS NULL
ORDER BY c.[customer_id];
```
# 6. Least selling categories by State 
- Identify the least selling product category for each state
- Challenge: Include the total sales for that category within each state
```sql
-- Least selling categories by state
WITH ranking_table AS (
    SELECT 
        c.[state],
        cat.[category],
        SUM(oi.[total_sale]) AS [total_sale],
        RANK() OVER (PARTITION BY c.[state] ORDER BY SUM(oi.[total_sale]) ASC) AS [rank]
    FROM dbo.[orders] AS o
    JOIN dbo.[customers] AS c
        ON o.[customer_id] = c.[customer_id]
    JOIN dbo.[order_items] AS oi
        ON o.[order_id] = oi.[order_id]
    JOIN dbo.[products] AS p
        ON oi.[product_id] = p.[product_id]
    JOIN dbo.[category] AS cat
        ON p.[category_id] = cat.[category_id]
    GROUP BY c.[state], cat.[category]
)
SELECT 
    [state],
    [category],
    [total_sale]
FROM ranking_table
WHERE [rank] = 1
ORDER BY [state];
```
# 7. Customer Lifetime Value (CLTV)
- Calculate the total value of orders placed by each customer over their lifetime
- Challenge: Rank customers based on their city
```sql
SELECT 
    c.[customer_id],
    CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
    c.[city],
    SUM(oi.[total_sale]) AS [CLTV],
    DENSE_RANK() OVER (PARTITION BY c.[city] ORDER BY SUM(oi.[total_sale]) DESC) AS [city_ranking]
FROM dbo.[orders] AS o
JOIN dbo.[customers] AS c
    ON c.[customer_id] = o.[customer_id]
JOIN dbo.[order_items] AS oi
    ON oi.[order_id] = o.[order_id]
GROUP BY 
    c.[customer_id], 
    c.[first_name], 
    c.[last_name], 
    c.[city]
ORDER BY 
    c.[city], 
    [city_ranking];

# 8. Inventory Stock Alerts
- Query products with stock levels below a certain threshold (e.g., less than 10 units).
- Challenge: Include last restock date and warehouse information
```sql
SELECT 
    i.[product_id],
    p.[product_name],
    i.[stock] as [current_tock_left],
    i.[last_restock_date],
    i.[warehouse_id]
FROM dbo.[inventory] AS i
JOIN dbo.[products] AS p
    ON i.[product_id] = p.[product_id]
JOIN dbo.[warehouses] AS w
    ON i.[warehouse_id] = w.[warehouse_id]
WHERE i.[stock] < 10
ORDER BY i.[stock] ASC;
```
# 9. Shipping Delays
- Identify orders where the shipping date is later than 3 days after the order date
- Challegne: Include customer, order details and deliverry provider
```sql
SELECT 
    c.[customer_id],
    CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
    c.[email],
    o.[order_id],
    o.[order_date],
    s.[shipping_date],
    s.[shipping_provider],
    DATEDIFF(DAY, o.[order_date], s.[shipping_date]) AS [days_to_ship]
FROM dbo.[orders] AS o
JOIN dbo.[customers] AS c
    ON c.[customer_id] = o.[customer_id]
JOIN dbo.[shippings] AS s
    ON o.[order_id] = s.[order_id]
WHERE DATEDIFF(DAY, o.[order_date], s.[shipping_date]) > 3
ORDER BY [days_to_ship] DESC;
```
# 10. Payment Sucess Rate
- Calculate the percentage of successful payments across all orders
- Challenge: Include breakdowns by payment status (e.g., failed, pending)
```sql
SELECT 
    p.[payment_status],
    COUNT(*) AS [total_count],
    CAST(COUNT(*) AS DECIMAL) / (SELECT COUNT(*) FROM dbo.[payments]) * 100 AS [payment_success_rate]
FROM dbo.[orders] AS o
JOIN dbo.[payments] AS p
    ON o.[order_id] = p.[order_id]
GROUP BY p.[payment_status]
ORDER BY [payment_success_rate] DESC;
```
# 11. Top performing sellers
- Find the top 5 sellers based on total sales value
- Challenge: Include both successful and failed orders, and display their percentage of sucessful orders
```sql
-- Step 1: Find the top 5 sellers based on total sales value
WITH TopSellers AS (
    SELECT TOP 5 
        s.[seller_id], 
        s.[seller_name], 
        SUM(oi.[total_sale]) AS [total_sale]
    FROM dbo.[orders] AS o
    JOIN dbo.[sellers] AS s
        ON o.[seller_id] = s.[seller_id]
    JOIN dbo.[order_items] AS oi
        ON oi.[order_id] = o.[order_id]
    GROUP BY s.[seller_id], s.[seller_name]
    ORDER BY SUM(oi.[total_sale]) DESC
),

-- Step 2: Calculate order status breakdown for "Completed" and "Cancelled" orders
OrderBreakdown AS (
    SELECT 
        o.[seller_id],
        t.[seller_name],
        SUM(CASE WHEN o.[order_status] = 'Completed' THEN 1 ELSE 0 END) AS [completed_orders],
        SUM(CASE WHEN o.[order_status] = 'Cancelled' THEN 1 ELSE 0 END) AS [cancelled_orders],
        COUNT(*) AS [total_orders]
    FROM dbo.[orders] AS o
    JOIN TopSellers AS t
        ON o.[seller_id] = t.[seller_id]
    WHERE o.[order_status] IN ('Completed', 'Cancelled') -- Only include these statuses
    GROUP BY o.[seller_id], t.[seller_name]
)

-- Step 3: Add success rate calculation
SELECT 
    ob.[seller_id],
    ob.[seller_name],
    ob.[completed_orders],
    ob.[cancelled_orders],
    ob.[total_orders],
    ROUND(
        (100.0 * ob.[completed_orders]) / ob.[total_orders], 2
    ) AS [success_rate]
FROM OrderBreakdown AS ob
ORDER BY ob.[success_rate] DESC, ob.[seller_id];
```
# 12. Product Profit Margin 
- Calculate the profit margin for each product (difference between price and cost of goods sold)
- Challenge: Rank products by their profit margin, showing highest to lowest
```sql
SELECT 
    p.[product_id],
    p.[product_name],
    SUM(oi.[total_sale] - (p.[cogs] * oi.[quantity])) AS [total_profit],
    (SUM(oi.[total_sale] - (p.[cogs] * oi.[quantity])) / SUM(oi.[total_sale]) * 100) AS [profit_margin],
    DENSE_RANK() OVER (
        ORDER BY 
            (SUM(oi.[total_sale] - (p.[cogs] * oi.[quantity])) / SUM(oi.[total_sale]) * 100) DESC
    ) AS [product_rank]
FROM dbo.[order_items] AS oi
JOIN dbo.[products] AS p
    ON oi.[product_id] = p.[product_id]
GROUP BY 
    p.[product_id],
    p.[product_name]
ORDER BY 
    [profit_margin] DESC;
```
# 13. Most Returned Products
- Query the top 10 products by the number of returns
- Challenge : Display the return rate as a percentage of total units sold for each product
```sql
SELECT TOP 10
    p.[product_id],
    p.[product_name],
    COUNT(*) AS [total_unit_sold],
    SUM(CASE WHEN o.[order_status] = 'Returned' THEN 1 ELSE 0 END) AS [total_returned],
    (SUM(CASE WHEN o.[order_status] = 'Returned' THEN 1 ELSE 0 END) * 1.0 / COUNT(*) * 100) AS [return_percentage]
FROM 
    dbo.[order_items] oi
JOIN 
    dbo.[products] p ON oi.[product_id] = p.[product_id]
JOIN 
    dbo.[orders] o ON o.[order_id] = oi.[order_id]
GROUP BY 
    p.[product_id], 
    p.[product_name]
ORDER BY 
    [return_percentage] DESC;
```
# 14. Inactive Sellers
- Identify sellers who haven't made any sales in the last 6 months
- Challenge : Show the last sale date and total sales from those sellers
```sql
WITH cte1 AS (
    SELECT seller_id 
    FROM dbo.sellers
    WHERE seller_id NOT IN (
        SELECT seller_id 
        FROM dbo.orders  
        WHERE order_date >= DATEADD(MONTH, -6, GETDATE())
    )
)
SELECT 
    o.[seller_id],
    MAX(o.[order_date]) AS last_sale_date,
    SUM(oi.[total_sale]) AS total_sales
FROM 
    dbo.orders o
JOIN 
    cte1 ON o.[seller_id] = cte1.[seller_id]
JOIN 
    dbo.order_items oi ON o.[order_id] = oi.[order_id]
GROUP BY 
    o.[seller_id];
```
# 15. Identify customers into returning or new 
- if the customer has done more than 5 return categorise them as returning otherwise new
- Challenge: List customers id, name, total orders, total returns
```sql
SELECT 
    c.[customer_id],
    CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
    COUNT(o.[order_id]) AS [total_orders],
    SUM(CASE WHEN o.[order_status] = 'Returned' THEN 1 ELSE 0 END) AS [total_returns],
    CASE 
        WHEN SUM(CASE WHEN o.[order_status] = 'Returned' THEN 1 ELSE 0 END) > 5 THEN 'Returning'
        ELSE 'New'
    END AS [customer_category]
FROM 
    dbo.customers c
JOIN 
    dbo.orders o ON c.[customer_id] = o.[customer_id]
GROUP BY 
    c.[customer_id], c.[first_name], c.[last_name]
ORDER BY 
    [total_orders] DESC;
```
# 16. Top 5 customers by orders in each state 
- Identify the top 5 customers with the highest number of orders for each state
- Challegne : Include the number of orders and total sales for each customer 
```sql
WITH ranked_customers AS (
    SELECT 
        c.[customer_id],
        CONCAT(c.[first_name], ' ', c.[last_name]) AS [full_name],
        c.[state],
        COUNT(o.[order_id]) AS [total_orders],
        SUM(oi.[total_sale]) AS [total_sales],
        ROW_NUMBER() OVER (PARTITION BY c.[state] ORDER BY COUNT(o.[order_id]) DESC) AS [rank]
    FROM 
        dbo.customers c
    JOIN 
        dbo.orders o ON c.[customer_id] = o.[customer_id]
    JOIN 
        dbo.order_items oi ON o.[order_id] = oi.[order_id]
    GROUP BY 
        c.[customer_id], c.[first_name], c.[last_name], c.[state]
)
SELECT 
    [customer_id], 
    [full_name], 
    [state], 
    [total_orders], 
    [total_sales]
FROM 
    ranked_customers
WHERE 
    [rank] <= 5
ORDER BY 
    [state], [total_orders] DESC;
```
# 17. Revenue by Shipping Provider
- Calculate the total revenue handled by each shipping provider
- Challenge : Include the total number of orders handled and the average delivery time for each provider
``sql



